<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 4: Exporting for the Auditors | The CSV Chronicles</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-800">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="../index.html" class="flex items-center gap-2 text-slate-300 hover:text-white">
                <span>üîÑ</span>
                <span class="font-bold">The CSV Chronicles</span>
            </a>
            <div class="flex items-center gap-4">
                <a href="chapter-3.html" class="text-slate-400 hover:text-slate-300 text-sm">‚Üê Prev</a>
                <span class="text-slate-500 text-sm">Chapter 4 of 5</span>
                <a href="chapter-5.html" class="text-blue-400 hover:text-blue-300 text-sm">Next ‚Üí</a>
            </div>
        </div>
    </nav>

    <!-- Chapter Title Card -->
    <div class="chapter-title-card mx-4 mt-8 md:mx-auto md:max-w-4xl" style="border-color: #10b981;">
        <div class="chapter-number">CHAPTER FOUR</div>
        <h1>Exporting for the Auditors</h1>
        <p class="subtitle">In which our hero learns to extract data from Nautobot into CSV reports</p>
    </div>

    <!-- Story Content -->
    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <!-- Opening Scene -->
        <div class="comic-page">
            <div class="narrator-box mb-6">
                Thursday afternoon. An urgent email arrives from the Compliance team...
            </div>
            
            <div class="comic-row cols-2">
                <div class="panel">
                    <div class="bg-slate-900 rounded-lg p-4 font-mono text-sm mb-4">
                        <div class="text-slate-500 mb-2">üìß From: compliance@dataflow.com</div>
                        <div class="text-slate-500 mb-2">Subject: URGENT - Network Inventory Audit</div>
                        <div class="text-slate-300 mt-4">
                            <p>Alex,</p>
                            <p class="mt-2">The auditors need a complete network inventory by Monday. They require:</p>
                            <ul class="mt-2 ml-4 space-y-1">
                                <li>‚Ä¢ All devices with their locations</li>
                                <li>‚Ä¢ IP address assignments</li>
                                <li>‚Ä¢ Everything in CSV format</li>
                            </ul>
                            <p class="mt-2">Thanks,<br>Compliance Team</p>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="character">
                        <div class="character-avatar">üë®‚Äçüíª</div>
                        <div>
                            <div class="character-name text-sm">Alex</div>
                        </div>
                    </div>
                    <div class="thought-bubble">
                        I've mastered importing... now I need to export! Time to build some 
                        CSV export Jobs.
                    </div>
                    <div class="speech-bubble mt-4">
                        "Good thing all the TechNova data is now in Nautobot. I just need to 
                        query it and generate CSV reports."
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Building Export Job -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üì§ Building the Export Job</h2>
            
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-blue-400 mb-4">Approach: Query ‚Üí Format ‚Üí Output</h3>
                
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-slate-800 rounded-lg p-4 text-center">
                        <div class="text-3xl mb-2">üîç</div>
                        <h4 class="font-bold text-blue-400">Query</h4>
                        <p class="text-sm text-slate-400">Use Django QuerySets to get data</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-4 text-center">
                        <div class="text-3xl mb-2">üìù</div>
                        <h4 class="font-bold text-emerald-400">Format</h4>
                        <p class="text-sm text-slate-400">Convert objects to CSV rows</p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-4 text-center">
                        <div class="text-3xl mb-2">üì§</div>
                        <h4 class="font-bold text-purple-400">Output</h4>
                        <p class="text-sm text-slate-400">Write to file or return as download</p>
                    </div>
                </div>
            </div>
            
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">Step 1: Query Nautobot Data</h3>
                
                <p class="text-slate-300 mb-4">
                    Django's QuerySet API makes it easy to retrieve data:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">QuerySet examples</span>
                    </div>
                    <pre><code class="language-python">from nautobot.dcim.models import Device, Interface
from nautobot.ipam.models import IPAddress

# Get all devices
all_devices = Device.objects.all()

# Filter by location
datacenter_devices = Device.objects.filter(location__name="Data Center")

# Filter by role
switches = Device.objects.filter(role__name="Access Switch")

# Filter by multiple criteria
active_switches = Device.objects.filter(
    role__name="Access Switch",
    status__name="Active"
)

# Order results
devices_sorted = Device.objects.all().order_by('name')

# Get related data efficiently (avoid N+1 queries)
devices_with_relations = Device.objects.select_related(
    'device_type',
    'location',
    'role',
    'status'
).all()</code></pre>
                </div>
                
                <div class="narrator-box mt-4">
                    üí° <strong>select_related()</strong> fetches related objects in a single query, 
                    dramatically improving performance when accessing foreign key fields!
                </div>
            </div>
            
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-purple-400 mb-4">Step 2: Generate CSV Output</h3>
                
                <p class="text-slate-300 mb-4">
                    Alex builds a Job that exports device inventory to CSV:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/device_export.py</span>
                    </div>
                    <pre><code class="language-python">import csv
from io import StringIO

from nautobot.apps.jobs import Job, register_jobs, ObjectVar, MultiObjectVar
from nautobot.dcim.models import Device, Location
from nautobot.extras.models import Status


class DeviceCSVExport(Job):
    """Export devices to CSV format."""
    
    class Meta:
        name = "Device CSV Export"
        description = "Generate a CSV report of devices"
    
    # Optional: Filter by location
    location = ObjectVar(
        model=Location,
        required=False,
        description="Filter by location (leave empty for all)"
    )
    
    # Optional: Filter by status
    status = ObjectVar(
        model=Status,
        required=False,
        description="Filter by status (leave empty for all)"
    )
    
    def run(self, location=None, status=None):
        # Build the query
        queryset = Device.objects.select_related(
            'device_type__manufacturer',
            'location',
            'role',
            'status'
        )
        
        # Apply filters if provided
        if location:
            queryset = queryset.filter(location=location)
        if status:
            queryset = queryset.filter(status=status)
        
        # Order by name
        queryset = queryset.order_by('name')
        
        # Create CSV output
        output = StringIO()
        writer = csv.writer(output)
        
        # Write header
        writer.writerow([
            'hostname',
            'device_type',
            'manufacturer',
            'role',
            'location',
            'status'
        ])
        
        # Write data rows
        for device in queryset:
            writer.writerow([
                device.name,
                device.device_type.model,
                device.device_type.manufacturer.name,
                device.role.name if device.role else '',
                device.location.name if device.location else '',
                device.status.name if device.status else '',
            ])
        
        # Get the CSV content
        csv_content = output.getvalue()
        
        # Log the output
        self.logger.info(f"Generated CSV with {queryset.count()} devices")
        self.logger.info("=" * 50)
        self.logger.info("CSV Preview (first 20 lines):")
        for line in csv_content.split('\n')[:20]:
            self.logger.info(line)
        
        return f"Exported {queryset.count()} devices to CSV"


register_jobs(DeviceCSVExport)</code></pre>
                </div>
            </div>
        </section>
        
        <!-- ObjectVar Explanation -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üéõÔ∏è Using ObjectVar for Filters</h2>
            
            <div class="comic-row cols-2 mb-6">
                <div class="panel">
                    <div class="character">
                        <div class="character-avatar">üë®‚Äçüíª</div>
                        <div>
                            <div class="character-name text-sm">Alex</div>
                        </div>
                    </div>
                    <div class="speech-bubble">
                        "ObjectVar creates a dropdown in the Job UI that lets users select 
                        a Nautobot object. Perfect for filtering!"
                    </div>
                </div>
                
                <div class="panel featured">
                    <h4 class="font-bold text-blue-400 mb-3">Common Job Variables</h4>
                    <ul class="text-sm text-slate-300 space-y-2">
                        <li><code class="text-purple-400">FileVar</code> - File upload</li>
                        <li><code class="text-purple-400">ObjectVar</code> - Single object dropdown</li>
                        <li><code class="text-purple-400">MultiObjectVar</code> - Multi-select</li>
                        <li><code class="text-purple-400">StringVar</code> - Text input</li>
                        <li><code class="text-purple-400">BooleanVar</code> - Checkbox</li>
                        <li><code class="text-purple-400">ChoiceVar</code> - Dropdown with choices</li>
                    </ul>
                </div>
            </div>
            
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-amber-400 mb-4">Example: MultiObjectVar for Multiple Selections</h3>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">MultiObjectVar example</span>
                    </div>
                    <pre><code class="language-python">from nautobot.apps.jobs import Job, MultiObjectVar
from nautobot.dcim.models import Location

class MultiLocationExport(Job):
    """Export devices from multiple locations."""
    
    class Meta:
        name = "Multi-Location Export"
    
    # Multi-select dropdown
    locations = MultiObjectVar(
        model=Location,
        required=False,
        description="Select one or more locations"
    )
    
    def run(self, locations=None):
        queryset = Device.objects.all()
        
        if locations:
            # Filter by multiple locations
            queryset = queryset.filter(location__in=locations)
        
        # ... rest of export logic</code></pre>
                </div>
            </div>
        </section>
        
        <!-- File Output -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üíæ Creating Downloadable Files</h2>
            
            <div class="panel mb-6">
                <div class="narrator-box mb-4">
                    The compliance team wants to download the CSV file, not just view it in logs...
                </div>
                
                <h3 class="text-xl font-bold text-emerald-400 mb-4">Using FileProxy for Downloads</h3>
                
                <p class="text-slate-300 mb-4">
                    Nautobot Jobs can create downloadable files using <code>FileProxy</code>:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/device_export_download.py</span>
                    </div>
                    <pre><code class="language-python">import csv
from io import StringIO
from datetime import datetime

from nautobot.apps.jobs import Job, register_jobs, ObjectVar
from nautobot.core.celery import register_jobs
from nautobot.dcim.models import Device, Location
from nautobot.extras.models import FileProxy


class DeviceCSVExportDownload(Job):
    """Export devices to a downloadable CSV file."""
    
    class Meta:
        name = "Device CSV Export (Download)"
        description = "Generate a downloadable CSV report"
    
    location = ObjectVar(
        model=Location,
        required=False,
        description="Filter by location"
    )
    
    def run(self, location=None):
        # Build query
        queryset = Device.objects.select_related(
            'device_type__manufacturer',
            'location',
            'role',
            'status'
        ).order_by('name')
        
        if location:
            queryset = queryset.filter(location=location)
        
        # Generate CSV content
        output = StringIO()
        writer = csv.writer(output)
        
        writer.writerow([
            'hostname', 'device_type', 'manufacturer',
            'role', 'location', 'status'
        ])
        
        for device in queryset:
            writer.writerow([
                device.name,
                device.device_type.model,
                device.device_type.manufacturer.name,
                device.role.name if device.role else '',
                device.location.name if device.location else '',
                device.status.name if device.status else '',
            ])
        
        csv_content = output.getvalue()
        
        # Create downloadable file
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"device_export_{timestamp}.csv"
        
        # Create FileProxy for download
        file_proxy = FileProxy.objects.create(
            name=filename,
            job_result=self.job_result,
        )
        file_proxy.file.save(filename, ContentFile(csv_content.encode('utf-8')))
        
        self.logger.info(f"Created export file: {filename}")
        self.logger.info(f"Total devices: {queryset.count()}")
        
        return f"Export complete! Download: {filename}"


register_jobs(DeviceCSVExportDownload)</code></pre>
                </div>
                
                <div class="bg-emerald-900/30 border border-emerald-500/50 rounded-lg p-4 mt-4">
                    <h4 class="font-bold text-emerald-400 mb-2">üì• Where to Find Downloads</h4>
                    <p class="text-sm text-slate-300">
                        After the Job runs, find the download link in:
                    </p>
                    <ul class="text-sm text-slate-300 mt-2 space-y-1">
                        <li>‚Ä¢ Job Results page ‚Üí Files tab</li>
                        <li>‚Ä¢ Or directly in the Job output log</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- IP Address Export -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üåê Exporting IP Addresses</h2>
            
            <div class="comic-row cols-1 mb-6">
                <div class="panel">
                    <div class="character">
                        <div class="character-avatar">üë®‚Äçüíª</div>
                        <div>
                            <div class="character-name text-sm">Alex</div>
                        </div>
                    </div>
                    <div class="speech-bubble">
                        "The auditors also need IP address assignments. Let me create another export Job!"
                    </div>
                </div>
            </div>
            
            <div class="panel mb-6">
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/ip_export.py</span>
                    </div>
                    <pre><code class="language-python">import csv
from io import StringIO

from nautobot.apps.jobs import Job, register_jobs
from nautobot.ipam.models import IPAddress


class IPAddressCSVExport(Job):
    """Export IP addresses with their assignments."""
    
    class Meta:
        name = "IP Address CSV Export"
        description = "Generate a CSV report of all IP addresses"
    
    def run(self):
        # Query IP addresses with related data
        queryset = IPAddress.objects.select_related(
            'status',
            'parent',  # Prefix
        ).prefetch_related(
            'interfaces',  # M2M relationship
            'interfaces__device',
        ).order_by('host')
        
        output = StringIO()
        writer = csv.writer(output)
        
        # Header
        writer.writerow([
            'ip_address',
            'prefix',
            'status',
            'assigned_device',
            'assigned_interface',
            'dns_name',
            'description'
        ])
        
        for ip in queryset:
            # Get assigned interface/device if exists
            interface = ip.interfaces.first() if ip.interfaces.exists() else None
            device_name = interface.device.name if interface and interface.device else ''
            interface_name = interface.name if interface else ''
            
            writer.writerow([
                str(ip.address),
                str(ip.parent) if ip.parent else '',
                ip.status.name if ip.status else '',
                device_name,
                interface_name,
                ip.dns_name or '',
                ip.description or '',
            ])
        
        csv_content = output.getvalue()
        
        self.logger.info(f"Exported {queryset.count()} IP addresses")
        self.logger.info("=" * 50)
        for line in csv_content.split('\n')[:15]:
            self.logger.info(line)
        
        return f"Exported {queryset.count()} IP addresses"


register_jobs(IPAddressCSVExport)</code></pre>
                </div>
                
                <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4 mt-4">
                    <h4 class="font-bold text-blue-400 mb-2">üîó prefetch_related vs select_related</h4>
                    <table class="w-full text-sm mt-2">
                        <thead>
                            <tr class="text-left">
                                <th class="text-slate-400 pb-2">Method</th>
                                <th class="text-slate-400 pb-2">Use For</th>
                                <th class="text-slate-400 pb-2">Example</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr>
                                <td class="py-1"><code>select_related</code></td>
                                <td>ForeignKey, OneToOne</td>
                                <td>device.location</td>
                            </tr>
                            <tr>
                                <td class="py-1"><code>prefetch_related</code></td>
                                <td>ManyToMany, reverse FK</td>
                                <td>ip.interfaces.all()</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Victory Scene -->
        <section class="mt-12">
            <div class="comic-page">
                <div class="comic-row cols-1">
                    <div class="panel success">
                        <div class="narrator-box mb-4">
                            Friday morning. Alex generates the audit reports...
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 rounded-lg p-4">
                                <div class="text-emerald-400 font-bold mb-2">üìÑ device_export_20240115.csv</div>
                                <div class="text-2xl font-bold text-white">3,421</div>
                                <div class="text-slate-400 text-sm">devices exported</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-4">
                                <div class="text-blue-400 font-bold mb-2">üìÑ ip_export_20240115.csv</div>
                                <div class="text-2xl font-bold text-white">8,742</div>
                                <div class="text-slate-400 text-sm">IP addresses exported</div>
                            </div>
                        </div>
                        
                        <div class="character justify-center">
                            <div class="character-avatar">üë®‚Äçüíª</div>
                            <div>
                                <div class="character-name">Alex</div>
                            </div>
                        </div>
                        <div class="speech-bubble mx-auto" style="max-width: 450px;">
                            "Reports ready for the auditors! And these Jobs are reusable‚ÄîI can 
                            generate fresh reports anytime. But I still need to connect it all: 
                            devices, IPs, interfaces, prefixes..."
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Key Takeaways -->
        <section class="mt-12">
            <div class="panel">
                <h3 class="comic-title text-2xl text-center mb-6">üìù Chapter 4 Key Takeaways</h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-blue-400 mb-3">Querying Data</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì <code>filter()</code> for WHERE clauses</li>
                            <li>‚úì <code>select_related()</code> for ForeignKeys</li>
                            <li>‚úì <code>prefetch_related()</code> for M2M</li>
                            <li>‚úì <code>order_by()</code> for sorting</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-emerald-400 mb-3">CSV Export</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì <code>ObjectVar</code> for filter dropdowns</li>
                            <li>‚úì <code>StringIO</code> + <code>csv.writer</code></li>
                            <li>‚úì <code>FileProxy</code> for downloads</li>
                            <li>‚úì Log previews for quick checks</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Next Chapter Teaser -->
        <div class="panel mt-8" style="border-color: #8b5cf6;">
            <div class="text-center">
                <div class="text-3xl mb-2">üîÑ</div>
                <h3 class="text-xl font-bold text-purple-400 mb-2">Coming Up Next...</h3>
                <p class="text-slate-300">
                    In the final chapter, Alex builds the complete pipeline: importing and exporting 
                    Devices, Interfaces, IP Addresses, and Prefixes‚Äîall working together!
                </p>
            </div>
        </div>
        
        <!-- Chapter Navigation -->
        <div class="chapter-nav">
            <a href="chapter-3.html">
                <span>‚Üê</span>
                <span>Chapter 3</span>
            </a>
            <span class="text-slate-500">Chapter 4 of 5</span>
            <a href="chapter-5.html">
                <span>Chapter 5</span>
                <span>‚Üí</span>
            </a>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="py-8 px-4 border-t border-slate-800 mt-12">
        <div class="max-w-4xl mx-auto text-center text-slate-500">
            <p class="text-sm">
                <a href="../index.html" class="text-blue-400 hover:underline">The CSV Chronicles: The Merger</a>
                ¬∑ An intermediate Nautobot tutorial
            </p>
        </div>
    </footer>
    
    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
