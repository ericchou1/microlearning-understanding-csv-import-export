<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 3: Building Order from Disorder | The CSV Chronicles</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-800">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="../index.html" class="flex items-center gap-2 text-slate-300 hover:text-white">
                <span>üìä</span>
                <span class="font-bold">The CSV Chronicles</span>
            </a>
            <div class="flex items-center gap-4">
                <a href="chapter-2.html" class="text-slate-400 hover:text-slate-300 text-sm">‚Üê Prev</a>
                <span class="text-slate-500 text-sm">Chapter 3 of 5</span>
                <a href="chapter-4.html" class="text-blue-400 hover:text-blue-300 text-sm">Next ‚Üí</a>
            </div>
        </div>
    </nav>

    <!-- Chapter Title Card -->
    <div class="chapter-title-card mx-4 mt-8 md:mx-auto md:max-w-4xl">
        <div class="chapter-number">CHAPTER THREE</div>
        <h1>Building Order from Disorder</h1>
        <p class="subtitle">In which our hero learns to write clean, standardized CSV files</p>
    </div>

    <!-- Story Content -->
    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <!-- Opening Scene -->
        <div class="comic-page">
            <div class="narrator-box mb-6">
                One week later. Alex has validated dozens of CSV files and collected all the good data...
            </div>
            
            <div class="comic-row cols-2">
                <div class="panel">
                    <div class="panel-scene flex-col">
                        <span class="text-5xl mb-2">üìã</span>
                        <span class="text-2xl">‚Üí</span>
                        <span class="text-5xl mt-2">‚ú®üìÑ</span>
                    </div>
                    <div class="character">
                        <div class="character-avatar">üë®‚Äçüíª</div>
                        <div>
                            <div class="character-name text-sm">Alex</div>
                        </div>
                    </div>
                    <div class="speech-bubble">
                        "I've read all the messy files. Now I need to export this cleaned data 
                        into a standardized format everyone can use!"
                    </div>
                </div>
                
                <div class="panel featured">
                    <h3 class="text-lg font-bold text-blue-400 mb-3">The Goal:</h3>
                    <div class="csv-preview">
                        <table>
                            <thead>
                                <tr>
                                    <th>hostname</th>
                                    <th>ip_address</th>
                                    <th>device_type</th>
                                    <th>location</th>
                                    <th>status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>switch-01</td>
                                    <td>10.0.1.1</td>
                                    <td>switch</td>
                                    <td>building-a</td>
                                    <td>active</td>
                                </tr>
                                <tr>
                                    <td>router-core</td>
                                    <td>10.0.0.1</td>
                                    <td>router</td>
                                    <td>data-center</td>
                                    <td>active</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-sm text-slate-400 mt-3">
                        ‚úì Consistent naming ¬∑ ‚úì Normalized values ¬∑ ‚úì Standard columns
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Learning Section: Writing CSVs -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üìù Writing CSV Files with Python</h2>
            
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-blue-400 mb-4">Basic CSV Writing with csv.writer</h3>
                
                <p class="text-slate-300 mb-4">
                    The csv module makes writing just as easy as reading:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">write_basic.py</span>
                    </div>
                    <pre><code class="language-python">import csv

# Data to write
devices = [
    ['switch-01', '10.0.1.1', 'switch', 'building-a'],
    ['switch-02', '10.0.1.2', 'switch', 'building-a'],
    ['router-core', '10.0.0.1', 'router', 'data-center'],
]

# Write to CSV file
with open('devices_clean.csv', 'w', newline='') as file:
    writer = csv.writer(file)
    
    # Write header row
    writer.writerow(['hostname', 'ip_address', 'device_type', 'location'])
    
    # Write data rows
    for device in devices:
        writer.writerow(device)
    
    # Or write all at once:
    # writer.writerows(devices)

print("‚úÖ CSV file created successfully!")</code></pre>
                </div>
                
                <div class="bg-amber-900/30 border border-amber-500/50 rounded-lg p-4 mt-4">
                    <h4 class="font-bold text-amber-400 mb-2">‚ö†Ô∏è Important: newline=''</h4>
                    <p class="text-sm text-slate-300">
                        Always use <code>newline=''</code> when opening files for CSV writing on Windows. 
                        This prevents extra blank lines between rows.
                    </p>
                </div>
            </div>
            
            <!-- DictWriter Section -->
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">Better Approach: csv.DictWriter</h3>
                
                <p class="text-slate-300 mb-4">
                    Just like DictReader is better for reading, DictWriter makes writing cleaner:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">write_dict.py</span>
                    </div>
                    <pre><code class="language-python">import csv

# Data as list of dictionaries
devices = [
    {
        'hostname': 'switch-01',
        'ip_address': '10.0.1.1',
        'device_type': 'switch',
        'location': 'building-a',
        'status': 'active'
    },
    {
        'hostname': 'router-core',
        'ip_address': '10.0.0.1',
        'device_type': 'router',
        'location': 'data-center',
        'status': 'active'
    },
]

# Define the columns (and their order)
fieldnames = ['hostname', 'ip_address', 'device_type', 'location', 'status']

with open('devices_clean.csv', 'w', newline='') as file:
    writer = csv.DictWriter(file, fieldnames=fieldnames)
    
    # Write header row
    writer.writeheader()
    
    # Write all data rows
    writer.writerows(devices)

print("‚úÖ CSV file created with DictWriter!")</code></pre>
                </div>
                
                <div class="narrator-box success mt-4">
                    üí° <strong>Pro Tip:</strong> Using dictionaries means column order in your data doesn't matter - 
                    the fieldnames parameter controls the output order!
                </div>
            </div>
        </section>
        
        <!-- Data Transformation Section -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üîÑ Data Transformation Pipeline</h2>
            
            <div class="comic-page">
                <div class="comic-row cols-1">
                    <div class="panel">
                        <div class="character">
                            <div class="character-avatar">üë®‚Äçüíª</div>
                            <div>
                                <div class="character-name text-sm">Alex</div>
                            </div>
                        </div>
                        <div class="speech-bubble">
                            "I need a complete pipeline: read messy data, transform it, and write clean output!"
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel mb-6 mt-6">
                <h3 class="text-xl font-bold text-purple-400 mb-4">Complete Transformation Script</h3>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">transform_devices.py</span>
                    </div>
                    <pre><code class="language-python">import csv
from typing import Optional

def normalize_hostname(hostname: str) -> str:
    """Normalize hostname to lowercase with dashes."""
    return hostname.lower().strip().replace('_', '-').replace(' ', '-')

def normalize_location(location: str) -> str:
    """Normalize location names."""
    location_mapping = {
        'bldg a': 'building-a',
        'building a': 'building-a',
        'bldg b': 'building-b',
        'building b': 'building-b',
        'dc': 'data-center',
        'data center': 'data-center',
        'datacenter': 'data-center',
    }
    normalized = location.lower().strip()
    return location_mapping.get(normalized, normalized.replace(' ', '-'))

def normalize_device_type(dtype: str) -> str:
    """Normalize device type names."""
    type_mapping = {
        'sw': 'switch', 'switch': 'switch',
        'rtr': 'router', 'router': 'router',
        'fw': 'firewall', 'firewall': 'firewall',
    }
    return type_mapping.get(dtype.lower().strip(), dtype.lower().strip())

def transform_device(row: dict) -> Optional[dict]:
    """Transform a single device record. Returns None if invalid."""
    hostname = row.get('hostname', '').strip()
    ip = row.get('ip', row.get('ip_address', '')).strip()
    dtype = row.get('type', row.get('device_type', '')).strip()
    location = row.get('loc', row.get('location', '')).strip()
    
    # Skip invalid records
    if not hostname or not ip:
        return None
    
    return {
        'hostname': normalize_hostname(hostname),
        'ip_address': ip,
        'device_type': normalize_device_type(dtype),
        'location': normalize_location(location),
        'status': 'active'  # Default status
    }

def process_csv_files(input_files: list[str], output_file: str) -> dict:
    """Process multiple input files and create one clean output."""
    all_devices = []
    stats = {'processed': 0, 'valid': 0, 'skipped': 0}
    
    for input_file in input_files:
        print(f"üìñ Reading: {input_file}")
        with open(input_file, 'r') as f:
            reader = csv.DictReader(f)
            for row in reader:
                stats['processed'] += 1
                device = transform_device(row)
                if device:
                    all_devices.append(device)
                    stats['valid'] += 1
                else:
                    stats['skipped'] += 1
    
    # Remove duplicates (by hostname)
    seen = set()
    unique_devices = []
    for device in all_devices:
        if device['hostname'] not in seen:
            seen.add(device['hostname'])
            unique_devices.append(device)
    
    # Write output
    fieldnames = ['hostname', 'ip_address', 'device_type', 'location', 'status']
    with open(output_file, 'w', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(sorted(unique_devices, key=lambda x: x['hostname']))
    
    stats['duplicates_removed'] = len(all_devices) - len(unique_devices)
    stats['final_count'] = len(unique_devices)
    
    return stats

# Run the transformation
input_files = [
    'devices_old.csv',
    'devices_new_BACKUP.csv',
    'switches_maybe.csv'
]

stats = process_csv_files(input_files, 'network_inventory.csv')
print(f"\nüìä Transformation Complete!")
print(f"   Processed: {stats['processed']} rows")
print(f"   Valid: {stats['valid']} devices")
print(f"   Skipped: {stats['skipped']} invalid rows")
print(f"   Duplicates removed: {stats['duplicates_removed']}")
print(f"   Final output: {stats['final_count']} devices")</code></pre>
                </div>
            </div>
        </section>
        
        <!-- Best Practices -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">‚ú® CSV Best Practices</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="panel">
                    <h3 class="text-lg font-bold text-emerald-400 mb-4">‚úÖ DO:</h3>
                    <ul class="space-y-3 text-slate-300 text-sm">
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-400">‚úì</span>
                            <span>Use consistent column names (snake_case recommended)</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-400">‚úì</span>
                            <span>Include a header row</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-400">‚úì</span>
                            <span>Quote fields that contain commas</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-400">‚úì</span>
                            <span>Use UTF-8 encoding</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-emerald-400">‚úì</span>
                            <span>Normalize data values</span>
                        </li>
                    </ul>
                </div>
                
                <div class="panel chaos">
                    <h3 class="text-lg font-bold text-red-400 mb-4">‚ùå DON'T:</h3>
                    <ul class="space-y-3 text-slate-300 text-sm">
                        <li class="flex items-start gap-2">
                            <span class="text-red-400">‚úó</span>
                            <span>Use spaces in column names</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-red-400">‚úó</span>
                            <span>Mix data types in a column</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-red-400">‚úó</span>
                            <span>Leave empty rows in the middle</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-red-400">‚úó</span>
                            <span>Use inconsistent date formats</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-red-400">‚úó</span>
                            <span>Forget to handle special characters</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="panel mt-6">
                <h3 class="text-lg font-bold text-amber-400 mb-4">üîê Handling Special Characters</h3>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">special_chars.py</span>
                    </div>
                    <pre><code class="language-python">import csv

# Data with special characters
devices = [
    {'hostname': 'server-01', 'description': 'Main server, primary'},  # Has comma
    {'hostname': 'server-02', 'description': 'Backup "hot standby"'},  # Has quotes
    {'hostname': 'server-03', 'description': 'Line 1\nLine 2'},        # Has newline
]

# csv module handles quoting automatically!
with open('output.csv', 'w', newline='') as f:
    writer = csv.DictWriter(f, fieldnames=['hostname', 'description'],
                            quoting=csv.QUOTE_MINIMAL)  # Quote only when needed
    writer.writeheader()
    writer.writerows(devices)

# Result in file:
# hostname,description
# server-01,"Main server, primary"
# server-02,"Backup ""hot standby"""
# server-03,"Line 1
# Line 2"</code></pre>
                </div>
            </div>
        </section>
        
        <!-- Victory Scene -->
        <section class="mt-12">
            <div class="comic-page">
                <div class="comic-row cols-1">
                    <div class="panel success">
                        <div class="narrator-box mb-4">
                            After processing all 50 CSV files...
                        </div>
                        
                        <div class="text-center mb-4">
                            <div class="sfx large">VICTORY!</div>
                        </div>
                        
                        <div class="bg-slate-900 rounded-lg p-4 font-mono text-sm mb-4">
                            <div class="text-slate-500 mb-2">üìÅ Network_Documentation/</div>
                            <div class="ml-4 space-y-1">
                                <div class="text-emerald-400">‚îú‚îÄ‚îÄ üìÑ network_inventory.csv (478 devices)</div>
                                <div class="text-blue-400">‚îú‚îÄ‚îÄ üìÑ switches.csv (312 switches)</div>
                                <div class="text-amber-400">‚îú‚îÄ‚îÄ üìÑ routers.csv (89 routers)</div>
                                <div class="text-purple-400">‚îî‚îÄ‚îÄ üìÑ firewalls.csv (77 firewalls)</div>
                            </div>
                        </div>
                        
                        <div class="character justify-center">
                            <div class="character-avatar">üë®‚Äçüíª</div>
                            <div>
                                <div class="character-name">Alex</div>
                            </div>
                        </div>
                        <div class="speech-bubble mx-auto" style="max-width: 450px;">
                            "Clean, organized CSVs! But... I'm still just pushing files around. 
                            There has to be a better way to manage this data permanently..."
                        </div>
                        <div class="thought-bubble mx-auto mt-4" style="max-width: 300px;">
                            I keep hearing about this "Source of Truth" thing...
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Key Takeaways -->
        <section class="mt-12">
            <div class="panel">
                <h3 class="comic-title text-2xl text-center mb-6">üìù Chapter 3 Key Takeaways</h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-blue-400 mb-3">Writing CSVs</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì Use <code>csv.DictWriter</code> for clean code</li>
                            <li>‚úì Always use <code>newline=''</code></li>
                            <li>‚úì Call <code>writeheader()</code> first</li>
                            <li>‚úì Let csv module handle quoting</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-emerald-400 mb-3">Data Transformation</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì Create normalization functions</li>
                            <li>‚úì Handle multiple input formats</li>
                            <li>‚úì Remove duplicates</li>
                            <li>‚úì Sort output for consistency</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Try It Yourself -->
        <div class="try-it-section mt-12">
            <h3>üß™ Try It Yourself!</h3>
            <p class="text-slate-400 mb-4">
                Practice writing and transforming CSV data. Create your own data pipeline!
            </p>
            <a href="../exercises/exercise-3.py" class="exercise-link">
                <span>üìù</span>
                <span>Open Exercise 3</span>
            </a>
        </div>
        
        <!-- Chapter Navigation -->
        <div class="chapter-nav">
            <a href="chapter-2.html">
                <span>‚Üê</span>
                <span>Chapter 2</span>
            </a>
            <span class="text-slate-500">Chapter 3 of 5</span>
            <a href="chapter-4.html">
                <span>Chapter 4</span>
                <span>‚Üí</span>
            </a>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="py-8 px-4 border-t border-slate-800 mt-12">
        <div class="max-w-4xl mx-auto text-center text-slate-500">
            <p class="text-sm">
                <a href="../index.html" class="text-blue-400 hover:underline">The CSV Chronicles</a>
                ¬∑ A learning adventure for network engineers
            </p>
        </div>
    </footer>
    
    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>

