<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 3: When Things Go Wrong | The CSV Chronicles</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-800">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="../index.html" class="flex items-center gap-2 text-slate-300 hover:text-white">
                <span>üîÑ</span>
                <span class="font-bold">The CSV Chronicles</span>
            </a>
            <div class="flex items-center gap-4">
                <a href="chapter-2.html" class="text-slate-400 hover:text-slate-300 text-sm">‚Üê Prev</a>
                <span class="text-slate-500 text-sm">Chapter 3 of 5</span>
                <a href="chapter-4.html" class="text-blue-400 hover:text-blue-300 text-sm">Next ‚Üí</a>
            </div>
        </div>
    </nav>

    <!-- Chapter Title Card -->
    <div class="chapter-title-card mx-4 mt-8 md:mx-auto md:max-w-4xl" style="border-color: #f59e0b;">
        <div class="chapter-number">CHAPTER THREE</div>
        <h1>When Things Go Wrong</h1>
        <p class="subtitle">In which our hero learns about idempotency, validation, and graceful error handling</p>
    </div>

    <!-- Story Content -->
    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <!-- Opening Scene - The Problem -->
        <div class="comic-page">
            <div class="narrator-box warning mb-6">
                Wednesday morning. Alex runs the import Job again to test with a larger dataset...
            </div>
            
            <div class="comic-row cols-2">
                <div class="panel chaos">
                    <div class="code-panel">
                        <div class="code-panel-header">
                            <div class="dots">
                                <div class="dot red"></div>
                                <div class="dot yellow"></div>
                                <div class="dot green"></div>
                            </div>
                            <span class="filename">Job Output</span>
                        </div>
                        <pre><code class="language-text">ERROR | Row 2: Failed to create tn-sw-01: 
  UNIQUE constraint failed: dcim_device.name
ERROR | Row 3: Failed to create tn-sw-02:
  UNIQUE constraint failed: dcim_device.name
ERROR | Row 4: Failed to create tn-sw-03:
  UNIQUE constraint failed: dcim_device.name
...
Import Complete!
  Created: 0
  Errors: 2847</code></pre>
                    </div>
                    <div class="sfx text-center mt-3">CRASH!</div>
                </div>
                
                <div class="panel">
                    <div class="character">
                        <div class="character-avatar">üë®‚Äçüíª</div>
                        <div>
                            <div class="character-name text-sm">Alex</div>
                        </div>
                    </div>
                    <div class="shout-bubble">
                        UNIQUE CONSTRAINT?!
                    </div>
                    <div class="thought-bubble mt-4">
                        Of course... the devices already exist from my first test run. 
                        Running the import twice creates duplicates!
                    </div>
                </div>
            </div>
            
            <!-- The Problem Explained -->
            <div class="comic-row cols-1 mt-6">
                <div class="panel">
                    <h3 class="text-xl font-bold text-red-400 mb-4">üö® The Problem: Non-Idempotent Imports</h3>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                            <h4 class="font-bold text-red-400 mb-2">What Happened:</h4>
                            <ul class="text-sm text-slate-300 space-y-1">
                                <li>‚Ä¢ First run: Created devices successfully</li>
                                <li>‚Ä¢ Second run: Tried to create same devices</li>
                                <li>‚Ä¢ Device names must be unique</li>
                                <li>‚Ä¢ Database rejected duplicates</li>
                            </ul>
                        </div>
                        <div class="bg-emerald-900/20 border border-emerald-500/30 rounded-lg p-4">
                            <h4 class="font-bold text-emerald-400 mb-2">What We Need:</h4>
                            <ul class="text-sm text-slate-300 space-y-1">
                                <li>‚Ä¢ <strong>Idempotent</strong> imports</li>
                                <li>‚Ä¢ Check if device exists first</li>
                                <li>‚Ä¢ Update existing OR create new</li>
                                <li>‚Ä¢ Safe to run multiple times</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="narrator-box mt-4">
                        üí° <strong>Idempotent</strong> = Running the same operation multiple times produces 
                        the same result. Essential for reliable automation!
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Solution: get_or_create -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üõ°Ô∏è Solution: get_or_create</h2>
            
            <div class="panel mb-6">
                <div class="character">
                    <div class="character-avatar">üë®‚Äçüíª</div>
                    <div>
                        <div class="character-name text-sm">Alex</div>
                    </div>
                </div>
                <div class="speech-bubble">
                    "Django has a built-in method for this: <code>get_or_create()</code>. 
                    It either retrieves an existing object or creates a new one!"
                </div>
            </div>
            
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-blue-400 mb-4">How get_or_create Works</h3>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">get_or_create pattern</span>
                    </div>
                    <pre><code class="language-python"># Basic syntax
obj, created = Model.objects.get_or_create(
    # Fields to search by (lookup)
    name="my-device",
    # Fields to set only if creating (defaults)
    defaults={
        "status": active_status,
        "location": some_location,
    }
)

# 'created' is True if new object was created
# 'created' is False if existing object was returned
if created:
    print("Created new object!")
else:
    print("Object already existed")</code></pre>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-slate-800 rounded-lg p-4">
                        <h4 class="font-bold text-blue-400 mb-2">Lookup Fields</h4>
                        <p class="text-sm text-slate-300">
                            Fields used to find existing objects. Usually the unique identifier 
                            like <code>name</code> or a combination of fields.
                        </p>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-4">
                        <h4 class="font-bold text-emerald-400 mb-2">defaults</h4>
                        <p class="text-sm text-slate-300">
                            Fields set <strong>only when creating</strong> a new object. 
                            Existing objects won't be modified.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Updated Job -->
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">Updated Import Job with get_or_create</h3>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/device_import.py (idempotent version)</span>
                    </div>
                    <pre><code class="language-python"># Inside the run() method, replace the device creation with:

try:
    device, created = Device.objects.get_or_create(
        name=hostname,  # Lookup field
        defaults={
            "device_type": device_type,
            "role": role,
            "location": location,
            "status": active_status,
        }
    )
    
    if created:
        self.logger.info(f"‚úÖ Created: {hostname}")
        created_count += 1
    else:
        self.logger.info(f"‚è≠Ô∏è  Skipped (exists): {hostname}")
        skipped_count += 1
        
except Exception as e:
    self.logger.error(f"Row {row_num}: Error with {hostname}: {e}")
    error_count += 1</code></pre>
                </div>
                
                <div class="narrator-box success mt-4">
                    ‚úÖ Now running the import multiple times is safe! Existing devices are skipped.
                </div>
            </div>
        </section>
        
        <!-- Update or Create -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üîÑ Bonus: update_or_create</h2>
            
            <div class="comic-row cols-2 mb-6">
                <div class="panel">
                    <div class="character">
                        <div class="character-avatar">üë®‚Äçüíª</div>
                        <div>
                            <div class="character-name text-sm">Alex</div>
                        </div>
                    </div>
                    <div class="thought-bubble">
                        But what if TechNova sends updated CSVs? I want to update existing devices 
                        with new information, not just skip them...
                    </div>
                </div>
                
                <div class="panel featured">
                    <h4 class="font-bold text-purple-400 mb-3">update_or_create</h4>
                    <p class="text-sm text-slate-300">
                        Similar to <code>get_or_create</code>, but it <strong>updates</strong> 
                        existing objects with the values in <code>defaults</code>.
                    </p>
                </div>
            </div>
            
            <div class="panel mb-6">
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">update_or_create pattern</span>
                    </div>
                    <pre><code class="language-python"># update_or_create: Updates existing OR creates new
device, created = Device.objects.update_or_create(
    name=hostname,  # Lookup field
    defaults={
        "device_type": device_type,
        "role": role,
        "location": location,
        "status": active_status,
    }
)

if created:
    self.logger.info(f"‚úÖ Created: {hostname}")
    created_count += 1
else:
    self.logger.info(f"üîÑ Updated: {hostname}")
    updated_count += 1</code></pre>
                </div>
                
                <div class="bg-amber-900/30 border border-amber-500/50 rounded-lg p-4 mt-4">
                    <h4 class="font-bold text-amber-400 mb-2">‚ö†Ô∏è Choose Wisely</h4>
                    <table class="w-full text-sm mt-2">
                        <thead>
                            <tr class="text-left">
                                <th class="text-slate-400 pb-2">Method</th>
                                <th class="text-slate-400 pb-2">If Exists</th>
                                <th class="text-slate-400 pb-2">Use When</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr>
                                <td class="py-1"><code>get_or_create</code></td>
                                <td>Returns as-is</td>
                                <td>Don't overwrite local changes</td>
                            </tr>
                            <tr>
                                <td class="py-1"><code>update_or_create</code></td>
                                <td>Updates fields</td>
                                <td>CSV is source of truth</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Handling Missing Related Objects -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üîó Handling Missing Related Objects</h2>
            
            <div class="comic-page">
                <div class="comic-row cols-1">
                    <div class="panel chaos">
                        <div class="narrator-box warning mb-4">
                            Alex notices another problem in the CSV...
                        </div>
                        
                        <div class="csv-preview mb-4">
                            <table>
                                <thead>
                                    <tr>
                                        <th>hostname</th>
                                        <th>device_type</th>
                                        <th>role</th>
                                        <th>location</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>tn-sw-99</td>
                                        <td class="text-red-400">NEW-MODEL-X</td>
                                        <td>Access Switch</td>
                                        <td class="text-red-400">TechNova Branch Office</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="character">
                            <div class="character-avatar">üë®‚Äçüíª</div>
                            <div>
                                <div class="character-name text-sm">Alex</div>
                            </div>
                        </div>
                        <div class="speech-bubble">
                            "This device references a DeviceType and Location that don't exist in Nautobot yet. 
                            Should I skip it, or create the missing objects?"
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel mb-6 mt-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">Option: Auto-Create Missing Objects</h3>
                
                <p class="text-slate-300 mb-4">
                    For the Location, we can use <code>get_or_create</code> to automatically 
                    create missing locations:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">Auto-create missing Locations</span>
                    </div>
                    <pre><code class="language-python"># Get a default LocationType for new locations
from nautobot.dcim.models import LocationType

default_location_type = LocationType.objects.get(name="Site")

# Look up or create the Location
location, loc_created = Location.objects.get_or_create(
    name=location_name,
    defaults={
        "location_type": default_location_type,
        "status": active_status,
    }
)

if loc_created:
    self.logger.info(f"üìç Created new location: {location_name}")</code></pre>
                </div>
                
                <div class="bg-amber-900/30 border border-amber-500/50 rounded-lg p-4 mt-4">
                    <h4 class="font-bold text-amber-400 mb-2">‚ö†Ô∏è Be Careful with Auto-Creation</h4>
                    <p class="text-sm text-slate-300">
                        Auto-creating objects like DeviceTypes requires more data (manufacturer, model, etc.). 
                        Often it's better to:
                    </p>
                    <ul class="text-sm text-slate-300 mt-2 space-y-1">
                        <li>‚Ä¢ Log warnings for missing objects</li>
                        <li>‚Ä¢ Generate a report of what's missing</li>
                        <li>‚Ä¢ Create missing objects manually or with a separate Job</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- Complete Robust Job -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üìã The Robust Import Job</h2>
            
            <div class="panel mb-6">
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/device_import.py (robust version)</span>
                    </div>
                    <pre><code class="language-python">import csv
from io import StringIO

from nautobot.apps.jobs import Job, register_jobs, FileVar, BooleanVar
from nautobot.dcim.models import Device, DeviceType, Location, LocationType
from nautobot.extras.models import Role, Status


class DeviceCSVImport(Job):
    """Import devices from CSV with robust error handling."""
    
    class Meta:
        name = "Device CSV Import (Robust)"
        description = "Idempotent CSV import with error handling"
    
    csv_file = FileVar(
        description="CSV file with columns: hostname, device_type, role, location"
    )
    
    update_existing = BooleanVar(
        description="Update existing devices (vs skip them)",
        default=False
    )
    
    def run(self, csv_file, update_existing):
        file_content = csv_file.read().decode('utf-8')
        reader = csv.DictReader(StringIO(file_content))
        
        active_status = Status.objects.get(name="Active")
        default_loc_type = LocationType.objects.first()
        
        # Track results
        created = 0
        updated = 0
        skipped = 0
        errors = []
        
        for row_num, row in enumerate(reader, start=2):
            hostname = row.get('hostname', '').strip()
            if not hostname:
                continue
            
            device_type_name = row.get('device_type', '').strip()
            role_name = row.get('role', '').strip()
            location_name = row.get('location', '').strip()
            
            # Look up DeviceType (required, don't auto-create)
            try:
                device_type = DeviceType.objects.get(model=device_type_name)
            except DeviceType.DoesNotExist:
                errors.append(f"Row {row_num}: DeviceType '{device_type_name}' not found")
                continue
            
            # Look up Role (required)
            try:
                role = Role.objects.get(name=role_name)
            except Role.DoesNotExist:
                errors.append(f"Row {row_num}: Role '{role_name}' not found")
                continue
            
            # Get or create Location
            location, _ = Location.objects.get_or_create(
                name=location_name,
                defaults={
                    "location_type": default_loc_type,
                    "status": active_status,
                }
            )
            
            # Create or update device
            try:
                if update_existing:
                    device, was_created = Device.objects.update_or_create(
                        name=hostname,
                        defaults={
                            "device_type": device_type,
                            "role": role,
                            "location": location,
                            "status": active_status,
                        }
                    )
                    if was_created:
                        created += 1
                        self.logger.info(f"‚úÖ Created: {hostname}")
                    else:
                        updated += 1
                        self.logger.info(f"üîÑ Updated: {hostname}")
                else:
                    device, was_created = Device.objects.get_or_create(
                        name=hostname,
                        defaults={
                            "device_type": device_type,
                            "role": role,
                            "location": location,
                            "status": active_status,
                        }
                    )
                    if was_created:
                        created += 1
                        self.logger.info(f"‚úÖ Created: {hostname}")
                    else:
                        skipped += 1
                        
            except Exception as e:
                errors.append(f"Row {row_num}: {hostname} - {e}")
        
        # Log summary
        self.logger.info("=" * 50)
        self.logger.info("Import Complete!")
        self.logger.info(f"  Created: {created}")
        self.logger.info(f"  Updated: {updated}")
        self.logger.info(f"  Skipped: {skipped}")
        self.logger.info(f"  Errors: {len(errors)}")
        
        if errors:
            self.logger.warning("Errors encountered:")
            for error in errors[:10]:  # Show first 10
                self.logger.warning(f"  {error}")
            if len(errors) > 10:
                self.logger.warning(f"  ... and {len(errors) - 10} more")
        
        return f"Created: {created}, Updated: {updated}, Skipped: {skipped}, Errors: {len(errors)}"


register_jobs(DeviceCSVImport)</code></pre>
                </div>
            </div>
            
            <div class="panel">
                <h4 class="font-bold text-emerald-400 mb-3">‚ú® What's New in This Version:</h4>
                <ul class="space-y-2 text-slate-300 text-sm">
                    <li>‚úì <strong>BooleanVar</strong> - Adds a checkbox to choose update vs skip behavior</li>
                    <li>‚úì <strong>get_or_create for Locations</strong> - Auto-creates missing locations</li>
                    <li>‚úì <strong>Error collection</strong> - Gathers all errors for summary report</li>
                    <li>‚úì <strong>Detailed logging</strong> - Shows created, updated, skipped counts</li>
                    <li>‚úì <strong>Idempotent</strong> - Safe to run multiple times</li>
                </ul>
            </div>
        </section>
        
        <!-- Victory Scene -->
        <section class="mt-12">
            <div class="comic-page">
                <div class="comic-row cols-1">
                    <div class="panel success">
                        <div class="narrator-box mb-4">
                            Alex runs the improved Job on the full TechNova dataset...
                        </div>
                        
                        <div class="code-panel mb-4">
                            <div class="code-panel-header">
                                <div class="dots">
                                    <div class="dot red"></div>
                                    <div class="dot yellow"></div>
                                    <div class="dot green"></div>
                                </div>
                                <span class="filename">Job Output</span>
                            </div>
                            <pre><code class="language-text">INFO | ==================================================
INFO | Import Complete!
INFO |   Created: 2,847
INFO |   Updated: 0
INFO |   Skipped: 0
INFO |   Errors: 12
WARNING | Errors encountered:
WARNING |   Row 156: DeviceType 'Legacy-Router-2000' not found
WARNING |   Row 892: DeviceType 'Custom-Switch-v1' not found
...

Job completed successfully!</code></pre>
                        </div>
                        
                        <div class="character justify-center">
                            <div class="character-avatar">üë®‚Äçüíª</div>
                            <div>
                                <div class="character-name">Alex</div>
                            </div>
                        </div>
                        <div class="speech-bubble mx-auto" style="max-width: 450px;">
                            "2,847 devices imported! Only 12 errors‚Äîall due to missing DeviceTypes 
                            I'll need to create. And I can safely re-run this anytime. Perfect!"
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Key Takeaways -->
        <section class="mt-12">
            <div class="panel">
                <h3 class="comic-title text-2xl text-center mb-6">üìù Chapter 3 Key Takeaways</h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-blue-400 mb-3">Idempotent Imports</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì <code>get_or_create()</code> - Create or retrieve</li>
                            <li>‚úì <code>update_or_create()</code> - Create or update</li>
                            <li>‚úì Safe to run multiple times</li>
                            <li>‚úì Use <code>defaults</code> for non-lookup fields</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-emerald-400 mb-3">Error Handling</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì Collect errors, don't fail immediately</li>
                            <li>‚úì Log summaries at the end</li>
                            <li>‚úì Consider auto-creating some objects</li>
                            <li>‚úì Track created/updated/skipped counts</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Next Chapter Teaser -->
        <div class="panel mt-8" style="border-color: #10b981;">
            <div class="text-center">
                <div class="text-3xl mb-2">üì§</div>
                <h3 class="text-xl font-bold text-emerald-400 mb-2">Coming Up Next...</h3>
                <p class="text-slate-300">
                    In Chapter 4, the auditors come calling! Alex builds CSV export Jobs to 
                    generate compliance reports from Nautobot data.
                </p>
            </div>
        </div>
        
        <!-- Chapter Navigation -->
        <div class="chapter-nav">
            <a href="chapter-2.html">
                <span>‚Üê</span>
                <span>Chapter 2</span>
            </a>
            <span class="text-slate-500">Chapter 3 of 5</span>
            <a href="chapter-4.html">
                <span>Chapter 4</span>
                <span>‚Üí</span>
            </a>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="py-8 px-4 border-t border-slate-800 mt-12">
        <div class="max-w-4xl mx-auto text-center text-slate-500">
            <p class="text-sm">
                <a href="../index.html" class="text-blue-400 hover:underline">The CSV Chronicles: The Merger</a>
                ¬∑ An intermediate Nautobot tutorial
            </p>
        </div>
    </footer>
    
    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
