<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 2: Importing the Fleet | The CSV Chronicles</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav class="bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-800">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="../index.html" class="flex items-center gap-2 text-slate-300 hover:text-white">
                <span>üîÑ</span>
                <span class="font-bold">The CSV Chronicles</span>
            </a>
            <div class="flex items-center gap-4">
                <a href="chapter-1.html" class="text-slate-400 hover:text-slate-300 text-sm">‚Üê Prev</a>
                <span class="text-slate-500 text-sm">Chapter 2 of 5</span>
                <a href="chapter-3.html" class="text-blue-400 hover:text-blue-300 text-sm">Next ‚Üí</a>
            </div>
        </div>
    </nav>

    <!-- Chapter Title Card -->
    <div class="chapter-title-card mx-4 mt-8 md:mx-auto md:max-w-4xl">
        <div class="chapter-number">CHAPTER TWO</div>
        <h1>Importing the Fleet</h1>
        <p class="subtitle">In which our hero builds a CSV import Job and brings TechNova's devices into Nautobot</p>
    </div>

    <!-- Story Content -->
    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <!-- Opening Scene -->
        <div class="comic-page">
            <div class="narrator-box mb-6">
                Tuesday morning. Alex opens the first CSV file from TechNova and starts planning the import Job...
            </div>
            
            <div class="comic-row cols-2">
                <div class="panel">
                    <div class="narrator-box mb-4">
                        The TechNova device inventory CSV:
                    </div>
                    <div class="csv-preview">
                        <table>
                            <thead>
                                <tr>
                                    <th>hostname</th>
                                    <th>device_type</th>
                                    <th>role</th>
                                    <th>location</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>tn-sw-01</td>
                                    <td>Catalyst 9300</td>
                                    <td>Access Switch</td>
                                    <td>TechNova HQ</td>
                                </tr>
                                <tr>
                                    <td>tn-rtr-core</td>
                                    <td>ASR 1001-X</td>
                                    <td>Core Router</td>
                                    <td>TechNova DC</td>
                                </tr>
                                <tr>
                                    <td>tn-fw-01</td>
                                    <td>Firepower 2110</td>
                                    <td>Firewall</td>
                                    <td>TechNova DC</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">... and 2,844 more rows</p>
                </div>
                
                <div class="panel">
                    <div class="character">
                        <div class="character-avatar">üë®‚Äçüíª</div>
                        <div>
                            <div class="character-name text-sm">Alex</div>
                        </div>
                    </div>
                    <div class="thought-bubble">
                        Clean column names, consistent formatting... TechNova's IT team did good work.
                        Now I need to map these to Nautobot objects.
                    </div>
                    
                    <div class="bg-slate-800 rounded-lg p-3 mt-4 text-sm">
                        <div class="text-amber-400 font-bold mb-2">CSV ‚Üí Nautobot Mapping:</div>
                        <div class="space-y-1 text-slate-300">
                            <div><code>hostname</code> ‚Üí <code>Device.name</code></div>
                            <div><code>device_type</code> ‚Üí <code>Device.device_type</code></div>
                            <div><code>role</code> ‚Üí <code>Device.role</code></div>
                            <div><code>location</code> ‚Üí <code>Device.location</code></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Building the Import Job -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üõ†Ô∏è Building the Import Job</h2>
            
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-blue-400 mb-4">Step 1: Basic Structure with FileVar</h3>
                
                <p class="text-slate-300 mb-4">
                    Alex starts with the Job structure, using <code>FileVar</code> to accept CSV uploads:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/device_import.py</span>
                    </div>
                    <pre><code class="language-python">import csv
from io import StringIO

from nautobot.apps.jobs import Job, register_jobs, FileVar
from nautobot.dcim.models import Device, DeviceType, Location
from nautobot.extras.models import Role, Status


class DeviceCSVImport(Job):
    """Import devices from a CSV file into Nautobot."""
    
    class Meta:
        name = "Device CSV Import"
        description = "Upload a CSV file to import devices from TechNova acquisition"
    
    csv_file = FileVar(
        description="CSV file with columns: hostname, device_type, role, location"
    )
    
    def run(self, csv_file):
        """Process the uploaded CSV and create devices."""
        
        # Read and decode the file
        file_content = csv_file.read().decode('utf-8')
        self.logger.info(f"Received CSV file: {len(file_content)} bytes")
        
        # Parse CSV
        reader = csv.DictReader(StringIO(file_content))
        
        # Get the Active status (we'll use this for all imported devices)
        active_status = Status.objects.get(name="Active")
        
        # Process each row
        created_count = 0
        for row in reader:
            # We'll add the creation logic next...
            pass
        
        return f"Import complete! Created {created_count} devices."

register_jobs(DeviceCSVImport)</code></pre>
                </div>
                
                <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4 mt-4">
                    <h4 class="font-bold text-blue-400 mb-2">üîë Key Imports</h4>
                    <ul class="text-sm text-slate-300 space-y-1">
                        <li><code>StringIO</code> - Lets us use csv.DictReader on a string</li>
                        <li><code>FileVar</code> - Creates file upload field in the Job UI</li>
                        <li><code>Device, DeviceType, Location</code> - Nautobot DCIM models</li>
                        <li><code>Role, Status</code> - Nautobot extras models</li>
                    </ul>
                </div>
            </div>
            
            <!-- Step 2: Looking up related objects -->
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">Step 2: Looking Up Related Objects</h3>
                
                <div class="comic-row cols-2 mb-4">
                    <div class="panel">
                        <div class="character">
                            <div class="character-avatar">üë®‚Äçüíª</div>
                            <div>
                                <div class="character-name text-sm">Alex</div>
                            </div>
                        </div>
                        <div class="thought-bubble">
                            A Device in Nautobot has relationships to other objects. 
                            I need to look up each one before creating the Device.
                        </div>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-4">
                        <div class="text-sm text-slate-300">
                            <div class="font-bold text-purple-400 mb-2">Device Relationships:</div>
                            <div class="space-y-1">
                                <div>‚Üí DeviceType (required)</div>
                                <div>‚Üí Location (required)</div>
                                <div>‚Üí Role (required)</div>
                                <div>‚Üí Status (required)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p class="text-slate-300 mb-4">
                    Alex adds the logic to look up each related object using Django's ORM:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/device_import.py (updated run method)</span>
                    </div>
                    <pre><code class="language-python">def run(self, csv_file):
    """Process the uploaded CSV and create devices."""
    
    # Read and decode the file
    file_content = csv_file.read().decode('utf-8')
    self.logger.info(f"Processing CSV file...")
    
    # Parse CSV
    reader = csv.DictReader(StringIO(file_content))
    
    # Get the Active status
    active_status = Status.objects.get(name="Active")
    
    # Track results
    created_count = 0
    error_count = 0
    
    for row_num, row in enumerate(reader, start=2):
        hostname = row.get('hostname', '').strip()
        device_type_name = row.get('device_type', '').strip()
        role_name = row.get('role', '').strip()
        location_name = row.get('location', '').strip()
        
        # Look up related objects
        try:
            device_type = DeviceType.objects.get(model=device_type_name)
        except DeviceType.DoesNotExist:
            self.logger.warning(f"Row {row_num}: DeviceType '{device_type_name}' not found, skipping")
            error_count += 1
            continue
        
        try:
            role = Role.objects.get(name=role_name)
        except Role.DoesNotExist:
            self.logger.warning(f"Row {row_num}: Role '{role_name}' not found, skipping")
            error_count += 1
            continue
        
        try:
            location = Location.objects.get(name=location_name)
        except Location.DoesNotExist:
            self.logger.warning(f"Row {row_num}: Location '{location_name}' not found, skipping")
            error_count += 1
            continue
        
        # Create the device (next step!)
        # ...
    
    return f"Created {created_count} devices, {error_count} errors"</code></pre>
                </div>
                
                <div class="narrator-box mt-4">
                    üí° <strong>Important:</strong> The related objects (DeviceType, Role, Location) must already 
                    exist in Nautobot before importing devices. We'll handle missing objects in Chapter 3!
                </div>
            </div>
            
            <!-- Step 3: Creating the Device -->
            <div class="panel mb-6">
                <h3 class="text-xl font-bold text-purple-400 mb-4">Step 3: Creating the Device</h3>
                
                <p class="text-slate-300 mb-4">
                    With all related objects found, Alex adds the device creation code:
                </p>
                
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">Device creation code</span>
                    </div>
                    <pre><code class="language-python"># After looking up all related objects...

# Create the device
device = Device(
    name=hostname,
    device_type=device_type,
    role=role,
    location=location,
    status=active_status,
)

# validated_save() validates the data before saving
device.validated_save()

self.logger.info(f"‚úÖ Created device: {hostname}")
created_count += 1</code></pre>
                </div>
                
                <div class="bg-emerald-900/30 border border-emerald-500/50 rounded-lg p-4 mt-4">
                    <h4 class="font-bold text-emerald-400 mb-2">Why validated_save()?</h4>
                    <p class="text-sm text-slate-300">
                        <code>validated_save()</code> is Nautobot's enhanced save method that:
                    </p>
                    <ul class="text-sm text-slate-300 mt-2 space-y-1">
                        <li>‚Ä¢ Runs model validation before saving</li>
                        <li>‚Ä¢ Ensures all required fields are present</li>
                        <li>‚Ä¢ Raises clear errors if validation fails</li>
                    </ul>
                    <p class="text-sm text-slate-400 mt-2">
                        Always prefer <code>validated_save()</code> over <code>save()</code> in Nautobot Jobs!
                    </p>
                </div>
            </div>
        </section>
        
        <!-- Complete Job -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üìã The Complete Import Job</h2>
            
            <div class="panel mb-6">
                <div class="code-panel">
                    <div class="code-panel-header">
                        <div class="dots">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <span class="filename">jobs/device_import.py (complete)</span>
                    </div>
                    <pre><code class="language-python">import csv
from io import StringIO

from nautobot.apps.jobs import Job, register_jobs, FileVar
from nautobot.dcim.models import Device, DeviceType, Location
from nautobot.extras.models import Role, Status


class DeviceCSVImport(Job):
    """Import devices from a CSV file into Nautobot."""
    
    class Meta:
        name = "Device CSV Import"
        description = "Upload a CSV file to import devices"
    
    csv_file = FileVar(
        description="CSV file with columns: hostname, device_type, role, location"
    )
    
    def run(self, csv_file):
        """Process the uploaded CSV and create devices."""
        
        # Read and decode the file
        file_content = csv_file.read().decode('utf-8')
        self.logger.info("Processing CSV file...")
        
        # Parse CSV using StringIO to treat string as file
        reader = csv.DictReader(StringIO(file_content))
        
        # Get the Active status once (reuse for all devices)
        active_status = Status.objects.get(name="Active")
        
        # Track results
        created_count = 0
        error_count = 0
        
        for row_num, row in enumerate(reader, start=2):
            # Extract fields from CSV row
            hostname = row.get('hostname', '').strip()
            device_type_name = row.get('device_type', '').strip()
            role_name = row.get('role', '').strip()
            location_name = row.get('location', '').strip()
            
            # Skip empty rows
            if not hostname:
                continue
            
            # Look up DeviceType
            try:
                device_type = DeviceType.objects.get(model=device_type_name)
            except DeviceType.DoesNotExist:
                self.logger.warning(
                    f"Row {row_num}: DeviceType '{device_type_name}' not found"
                )
                error_count += 1
                continue
            
            # Look up Role
            try:
                role = Role.objects.get(name=role_name)
            except Role.DoesNotExist:
                self.logger.warning(
                    f"Row {row_num}: Role '{role_name}' not found"
                )
                error_count += 1
                continue
            
            # Look up Location
            try:
                location = Location.objects.get(name=location_name)
            except Location.DoesNotExist:
                self.logger.warning(
                    f"Row {row_num}: Location '{location_name}' not found"
                )
                error_count += 1
                continue
            
            # Create the device
            try:
                device = Device(
                    name=hostname,
                    device_type=device_type,
                    role=role,
                    location=location,
                    status=active_status,
                )
                device.validated_save()
                self.logger.info(f"‚úÖ Created: {hostname}")
                created_count += 1
                
            except Exception as e:
                self.logger.error(f"Row {row_num}: Failed to create {hostname}: {e}")
                error_count += 1
        
        # Summary
        self.logger.info("=" * 50)
        self.logger.info(f"Import Complete!")
        self.logger.info(f"  Created: {created_count}")
        self.logger.info(f"  Errors: {error_count}")
        
        return f"Created {created_count} devices, {error_count} errors"


register_jobs(DeviceCSVImport)</code></pre>
                </div>
            </div>
        </section>
        
        <!-- Running the Job -->
        <section class="mt-12">
            <h2 class="comic-title text-3xl text-center mb-8">üöÄ Running the Import</h2>
            
            <div class="comic-page">
                <div class="comic-row cols-1">
                    <div class="panel">
                        <div class="narrator-box mb-4">
                            Alex enables the Job in Nautobot and runs the first test import...
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 rounded-lg p-4">
                                <h4 class="font-bold text-blue-400 mb-2">Step 1: Enable the Job</h4>
                                <ol class="text-sm text-slate-300 space-y-1">
                                    <li>1. Navigate to <strong>Jobs ‚Üí Jobs</strong></li>
                                    <li>2. Find "Device CSV Import"</li>
                                    <li>3. Click <strong>Edit</strong></li>
                                    <li>4. Check <strong>Enabled</strong></li>
                                    <li>5. Click <strong>Save</strong></li>
                                </ol>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-4">
                                <h4 class="font-bold text-emerald-400 mb-2">Step 2: Run the Job</h4>
                                <ol class="text-sm text-slate-300 space-y-1">
                                    <li>1. Click the Job name</li>
                                    <li>2. Click <strong>Run</strong></li>
                                    <li>3. Upload your CSV file</li>
                                    <li>4. Click <strong>Run Job</strong></li>
                                    <li>5. View results in Job log</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Job Output -->
                <div class="comic-row cols-1 mt-6">
                    <div class="panel success">
                        <h4 class="font-bold text-emerald-400 mb-4">üìã Job Output</h4>
                        
                        <div class="code-panel">
                            <div class="code-panel-header">
                                <div class="dots">
                                    <div class="dot red"></div>
                                    <div class="dot yellow"></div>
                                    <div class="dot green"></div>
                                </div>
                                <span class="filename">Job Log</span>
                            </div>
                            <pre><code class="language-text">INFO | Processing CSV file...
INFO | ‚úÖ Created: tn-sw-01
INFO | ‚úÖ Created: tn-sw-02
INFO | ‚úÖ Created: tn-sw-03
WARNING | Row 5: DeviceType 'Unknown Model' not found
INFO | ‚úÖ Created: tn-rtr-core
INFO | ‚úÖ Created: tn-fw-01
INFO | ==================================================
INFO | Import Complete!
INFO |   Created: 5
INFO |   Errors: 1

Job completed: Created 5 devices, 1 errors</code></pre>
                        </div>
                        
                        <div class="character justify-center mt-4">
                            <div class="character-avatar">üë®‚Äçüíª</div>
                            <div>
                                <div class="character-name">Alex</div>
                            </div>
                        </div>
                        <div class="speech-bubble mx-auto" style="max-width: 450px;">
                            "It's working! The devices are being created. But that error... 
                            what happens if I run this twice? I need better error handling."
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Key Takeaways -->
        <section class="mt-12">
            <div class="panel">
                <h3 class="comic-title text-2xl text-center mb-6">üìù Chapter 2 Key Takeaways</h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-blue-400 mb-3">CSV Import Basics</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì <code>FileVar</code> creates file upload UI</li>
                            <li>‚úì <code>StringIO</code> wraps string for csv.DictReader</li>
                            <li>‚úì Decode bytes: <code>.read().decode('utf-8')</code></li>
                            <li>‚úì Track row numbers for error reporting</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-emerald-400 mb-3">Creating Objects</h4>
                        <ul class="space-y-2 text-slate-300 text-sm">
                            <li>‚úì Look up related objects first</li>
                            <li>‚úì Handle <code>DoesNotExist</code> exceptions</li>
                            <li>‚úì Use <code>validated_save()</code> to save</li>
                            <li>‚úì Log progress with <code>self.logger</code></li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Next Chapter Teaser -->
        <div class="panel mt-8" style="border-color: #f59e0b;">
            <div class="text-center">
                <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                <h3 class="text-xl font-bold text-amber-400 mb-2">Coming Up Next...</h3>
                <p class="text-slate-300">
                    In Chapter 3, Alex discovers the dangers of running imports twice, learns about 
                    idempotency, and builds robust error handling with <code>get_or_create</code>.
                </p>
            </div>
        </div>
        
        <!-- Chapter Navigation -->
        <div class="chapter-nav">
            <a href="chapter-1.html">
                <span>‚Üê</span>
                <span>Chapter 1</span>
            </a>
            <span class="text-slate-500">Chapter 2 of 5</span>
            <a href="chapter-3.html">
                <span>Chapter 3</span>
                <span>‚Üí</span>
            </a>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="py-8 px-4 border-t border-slate-800 mt-12">
        <div class="max-w-4xl mx-auto text-center text-slate-500">
            <p class="text-sm">
                <a href="../index.html" class="text-blue-400 hover:underline">The CSV Chronicles: The Merger</a>
                ¬∑ An intermediate Nautobot tutorial
            </p>
        </div>
    </footer>
    
    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
